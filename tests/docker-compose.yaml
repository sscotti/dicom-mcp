services:
  # PostgreSQL database for both Orthanc instances
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: orthanc
      POSTGRES_PASSWORD: orthanc
    # Will create multiple databases via init script
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-postgres.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - dicom-network

  # Enhanced Orthanc with plugins
  orthanc:
    image: orthancteam/orthanc:25.10.5-full
    ports:
      - 4242:4242
      - 8042:8042
    volumes:
      - ./orthanc.configuration.json:/etc/orthanc/orthanc.json
      - orthanc_storage:/var/lib/orthanc/db
      - ../cert-key-combined.pem:/etc/orthanc/certs/https.pem:ro
      - ../cert.pem:/etc/orthanc/certs/dicom-tls-cert.pem:ro
      - ../key.pem:/etc/orthanc/certs/dicom-tls-key.pem:ro
    env_file:
      - ../.env
    environment:
      - VERBOSE_ENABLED="true"
      - VERBOSE_STARTUP="true"
      - ORTHANC__PYTHON_VERBOSE="true"
      - ORTHANC__POSTGRESQL_HOST=postgres
      - ORTHANC__POSTGRESQL_DATABASE=orthanc1
      - ORTHANC__POSTGRESQL_USERNAME=orthanc
      - ORTHANC__POSTGRESQL_PASSWORD=orthanc
    depends_on:
      - postgres
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - dicom-network

  # Secondary Orthanc with plugins
  orthanc2:
    image: orthancteam/orthanc:25.10.5-full
    ports:
      - 4243:4243
      - 8043:8043
    volumes:
      - ./orthanc2.configuration.json:/etc/orthanc/orthanc.json
      - orthanc2_storage:/var/lib/orthanc/db
      - ../cert-key-combined.pem:/etc/orthanc/certs/https.pem:ro
      - ../cert.pem:/etc/orthanc/certs/dicom-tls-cert.pem:ro
      - ../key.pem:/etc/orthanc/certs/dicom-tls-key.pem:ro
    env_file:
      - ../.env
    environment:
      - VERBOSE_ENABLED="true"
      - VERBOSE_STARTUP="true"
      - ORTHANC__PYTHON_VERBOSE="true"
      - ORTHANC__POSTGRESQL_HOST=postgres
      - ORTHANC__POSTGRESQL_DATABASE=orthanc2
      - ORTHANC__POSTGRESQL_USERNAME=orthanc
      - ORTHANC__POSTGRESQL_PASSWORD=orthanc
    depends_on:
      - postgres
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - dicom-network

volumes:
  postgres_data:
  orthanc_storage:
  orthanc2_storage:

networks:
  dicom-network:
    driver: bridge